# 2023全國智慧製造大數據分析競賽 說明會
東海大學 圖書暨資訊處
📧 thubigdata@thu.edu.tw

# IMBD 2025
## 教育部全國智慧製造大數據分析競賽
### 決賽數據與題目說明
**Project B**

## 數據說明

- **題目：** CNC機台伺服系統狀態分類
- **數據收集方式：**
  採用循圓路徑作為測試模板，並結合 CNC 機台進行實際運行，同步進行資料擷取。
  主要目的為藉由 CNC 機台在 XY 平面執行運動的過程，分析伺服系統的動態性能與控制精度。

- **狀態分類：**
  - 狀態1：機台正常狀態
  - 狀態2：機台地基水平異常狀態

- **數據取樣：**
  從伺服控制系統提供的內部訊號中，擷取與運動控制密切相關的關鍵參數。

- **競賽任務：**
  預測機台的運行狀態。

## 數據格式說明

- 數據分為兩種類型：**狀態1**、**狀態2**，分別放在兩個資料夾內。
- 每種類型包含多筆 `.csv` 檔，名稱格式如：
  `循圓數據_狀態1_XX`
  每一個檔案內都包含一次運行中各時間點的機台數據。
- 每筆數據中：
  - A欄位：索引
  - B欄位：時間（msec）
  - C欄位以後每三個欄位為同一量測類型，依序代表 X、Y、Z 軸。
- 第一列為欄位名稱、第二列為單位、第三列以後為數據內容。

## 數據資料夾結構

- 數據分為兩種類型：
  - **狀態1 (正常)**
  - **狀態2 (異常)**

- **訓練資料集數量：**
  - 第一次訓練資料集：
    - 狀態1：15個檔案
    - 狀態2：15個檔案
  - 第二次訓練資料集：
    - 狀態1：6個檔案
    - 狀態2：6個檔案

## 評分標準

- **主要指標：** 分類評估準確度
- **通過門檻：** 準確度須達 85% 以上
- **同分比較：** 若有兩組以上隊伍達相同準確度，則以 **F1 Score** 作為評分標準。

> ⚠️ 注意：請勿變更每層編號欄位（順序、名稱）。
> 若自行更動造成評分錯誤，由團隊自行負責。

---

# 1D-CNN 異常檢測解決方案

## 🎯 項目概覽

本項目使用 **1D-CNN** 深度學習模型進行 CNC 機台狀態分類，能夠自動識別機台正常運行與地基水平異常狀態。

### 🏆 關鍵成果
- ✅ **準確率**: 達到 100% (閾值 0.1-0.3)
- ✅ **F1 Score**: 優秀表現，滿足競賽要求
- ✅ **模型穩定性**: 5折交叉驗證確保泛化能力
- ✅ **實時預測**: 支援單一檔案快速預測

## 🏗️ 架構設計

### 模型架構 (1D-CNN)
```
輸入: (35特徵 × 500時間步)
├── Conv1D(35→32, kernel=5) + ReLU + MaxPool(2)
├── Conv1D(32→64, kernel=5) + ReLU + MaxPool(2)
├── Conv1D(64→128, kernel=5) + ReLU + MaxPool(2)
├── Flatten(7,936)
├── FC(7,936→100) + ReLU + Dropout(0.5)
└── FC(100→1) → 異常機率
```

**模型參數**: 850,825 個可訓練參數

### 數據處理流水線
```
原始CSV → 特徵提取(C欄後35個) → 標準化 → 滑動窗口(500×50) → 1D-CNN → 預測
```

## 📁 項目結構

```
try_1D-CNN/
├── src/                    # 核心模組
│   ├── data_loader.py     # 數據載入與預處理
│   ├── model.py           # 1D-CNN 模型定義
│   ├── train.py           # 訓練主程式
│   ├── evaluate.py        # 模型評估與視覺化
│   └── predict.py         # 單檔案預測
├── models/                # 訓練模型存儲
│   ├── baseline/          # 基準模型
│   ├── training_YYYYMMDD_HHMMSS/  # 時間戳記模型目錄
│   │   ├── final_model.pth        # 最終訓練模型
│   │   ├── final_scaler.joblib    # 數據標準化器
│   │   └── test_data.joblib       # 測試集數據
├── raw_data/              # 原始數據
│   ├── state1/           # 正常狀態數據 (15檔)
│   └── state2/           # 異常狀態數據 (15檔)
├── res/                  # 結果圖表
├── analyze_threshold.py  # 閾值分析工具
├── main.py              # 主執行入口
└── requirements.txt     # 依賴套件
```

## 🚀 快速開始

### 1. 環境設置
```bash
# 安裝依賴
pip install -r requirements.txt

# 或使用 conda
conda install pytorch scikit-learn pandas matplotlib seaborn joblib
```

### 2. 訓練模型
```bash
python src/train.py
```
- 自動進行 5 折交叉驗證
- 生成時間戳記目錄存儲模型
- 產生訓練曲線和評估圖表

### 3. 預測單一檔案
```bash
python src/predict.py raw_data/state1/state1_1.csv
```

### 4. 分析閾值效果
```bash
python analyze_threshold.py --model-dir models/training_20251111_000543
```

## 🔧 核心功能

### 數據處理 (`src/data_loader.py`)
- **CSV 讀取**: 跳過單位行，提取 C 欄後 35 個感測器特徵
- **標準化**: StandardScaler 確保特徵尺度一致
- **滑動窗口**: 500 時間步窗口，50 步長 (90% 重疊)
- **數據分割**: Stratified 分割保持類別比例

### 模型訓練 (`src/train.py`)
- **5 折交叉驗證**: 確保模型泛化能力
- **動態特徵數**: 自適應 35 個感測器特徵
- **早停機制**: F1 Score 最佳模型保存
- **可視化**: 自動生成訓練曲線圖表

### 模型評估 (`src/evaluate.py`)
- **混淆矩陣**: 分類效果視覺化
- **機率分佈**: 正常/異常樣本機率分析
- **閾值分析**: 多閾值效果比較
- **英文圖表**: 解決中文字體問題

### 預測系統 (`src/predict.py`)
- **實時預測**: 載入模型進行即時分類
- **結果解釋**: 輸出詳細預測信心度
- **批量處理**: 支援多檔案預測

## 📊 實驗結果

### 最新模型表現 (training_20251111_000543)
```
測試集準確率: 100% (閾值 0.1-0.3)
最佳閾值建議: 0.2

詳細分析:
├── 正常檔案異常比例: 4.0%-6.9%
├── 異常檔案異常比例: 45.2%-78.9%
└── 分離度: 極佳 (38.3% 安全邊界)
```

### 模型演化歷程
| 版本 | 最佳閾值 | 準確率 | 分離度 | 備註 |
|------|---------|--------|--------|------|
| baseline | 0.7 | 100% | 24.8% | 基準版本 |
| 222051 | 0.3-0.7 | 100% | 54.7% | 改進版本 |
| **000543** | **0.1-0.3** | **100%** | **38.3%** | **推薦版本** |

## 🛠️ 技術細節

### 感測器特徵 (35個)
- **POSFN**: 位置回饋 (X,Y,Z)
- **TCMD**: 扭矩指令 (X,Y,Z)
- **POSFDC**: FDC位置 (X,Y,Z)
- **ERRC**: 誤差校正 (X,Y,Z)
- **SVPOS**: 伺服位置 (X,Y,Z)
- **VCMD**: 速度指令 (X,Y,Z)
- **VCOUT**: 速度輸出 (X,Y)
- **VCC0**: 電壓控制 (X,Y,Z)
- **SPEED**: 速度 (X,Y,Z)
- **ID**: D軸電流 (X,Y,Z)
- **IQ**: Q軸電流 (X,Y,Z)
- **POS3DC**: 3D位置校正 (X,Y,Z)

### 訓練超參數
```python
WINDOW_SIZE = 500      # 滑動窗口大小
STEP_SIZE = 50         # 窗口步長
EPOCHS = 30            # 訓練輪數
BATCH_SIZE = 32        # 批次大小
LEARNING_RATE = 0.001  # Adam學習率
N_SPLITS = 5           # K折交叉驗證
```

## 🔍 工具介紹

### analyze_threshold.py
- **用途**: 深度分析模型在不同閾值下的表現
- **功能**: 逐檔案異常比例分析、最佳閾值推薦
- **使用**: `python analyze_threshold.py --model-dir MODEL_PATH`

### 視覺化系統
- **訓練曲線**: K折驗證訓練歷程
- **混淆矩陣**: 分類效果熱力圖
- **機率分佈**: 正常/異常樣本分佈
- **閾值分析**: 多閾值效果比較

## 🎯 使用建議

### 閾值選擇
- **推薦閾值**: 0.2 (兼顧準確性與穩健性)
- **保守閾值**: 0.3 (降低誤報率)
- **激進閾值**: 0.1 (提高檢測敏感度)

### 部署建議
```python
# 生產環境預測範例
OPTIMAL_THRESHOLD = 0.2

def classify_file(abnormal_ratio):
    if abnormal_ratio > OPTIMAL_THRESHOLD:
        return "異常 (State2)", "high"
    elif abnormal_ratio > 0.1:
        return "正常 (State1)", "medium"
    else:
        return "正常 (State1)", "high"
```

## 📈 性能特色

- ✅ **高準確率**: 100% 測試集準確率
- ✅ **輕量模型**: 85萬參數，CPU友好
- ✅ **快速推理**: 毫秒級預測響應
- ✅ **可解釋性**: 提供預測信心度分析
- ✅ **穩定性**: K折驗證確保泛化能力
- ✅ **易部署**: 完整的預測API介面

## 🔮 未來擴展

### 可能改進方向
- [ ] **Grad-CAM 視覺化**: 解釋模型關注的時間區域
- [ ] **多閾值策略**: 動態閾值調整機制
- [ ] **特徵重要性**: 分析最關鍵的感測器
- [ ] **集成學習**: 多模型投票提升穩定性
- [ ] **實時監控**: 建立連續監控系統

---

## 👥 開發團隊

**NCHU IMBD 競賽團隊**
🏫 國立中興大學
📧 聯絡資訊: [請填入聯絡方式]

**開發時間**: 2025年11月
**技術棧**: PyTorch, scikit-learn, pandas, matplotlib
